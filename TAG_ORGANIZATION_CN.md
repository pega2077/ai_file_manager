# 标签整理功能（近义词检查）

## 概述

本功能实现了智能标签整理，使用近义词检查来维护文件标签的一致性。当生成或更新标签时，系统会自动检查合并的标签库（预设标签 + 数据库标签），以保持标签一致性并减少含义相似的重复标签。

## 功能特性

### 1. 预设标签库配置

用户可以在应用配置文件 (`config.json`) 中配置预设标签库：

```json
{
  "presetTags": [
    "工作", "学习", "项目", "会议", "报告", "总结",
    "图片", "视频", "音频", "文档", "演示",
    "重要", "紧急", "参考", "归档", "草稿",
    "技术", "设计", "营销", "财务", "法律"
  ]
}
```

### 2. 标签库合并与缓存

标签服务会自动：
- 从配置中加载预设标签
- 从数据库查询所有唯一标签
- 合并为统一的标签库（预设标签优先）
- 缓存合并后的标签库（5分钟缓存时间）以提升性能

### 3. 近义词检查算法

当生成或更新新标签时，系统会：
1. **精确匹配检查**：首先检查不区分大小写的精确匹配
2. **相似度匹配**：使用 Levenshtein 距离算法查找相似标签
3. **基于阈值的替换**：如果相似度得分 >= 80%，则用现有标签替换新标签

**示例：**
- 新标签："報告" → 匹配预设标签："报告"（相似度 >= 80%）
- 新标签："技朮" → 匹配预设标签："技术"（相似度 >= 80%）
- 新标签："会谈" → 匹配预设标签："会议"（如果相似度 >= 80%）

### 4. 自动集成

近义词检查会自动应用于：
- 文件导入和自动标签生成时
- 用户通过 API 手动更新文件标签时
- 标签在保存到数据库之前会被规范化

## API 接口

### GET /api/tags/library

获取合并的标签库（预设标签 + 数据库标签）。

**查询参数：**
- `refresh`（可选）：设置为 `true` 强制刷新缓存

**响应：**
```json
{
  "success": true,
  "message": "ok",
  "data": {
    "tags": ["工作", "学习", "项目", ...],
    "count": 20
  },
  "error": null,
  "timestamp": "2025-11-15T08:20:11.097Z",
  "request_id": ""
}
```

### POST /api/tags/normalize

使用近义词检查规范化标签列表。

**请求体：**
```json
{
  "tags": ["報告", "学习资料", "技朮文档"]
}
```

**响应：**
```json
{
  "success": true,
  "message": "ok",
  "data": {
    "original": ["報告", "学习资料", "技朮文档"],
    "normalized": ["报告", "学习", "技术"]
  },
  "error": null,
  "timestamp": "2025-11-15T08:20:11.097Z",
  "request_id": ""
}
```

### POST /api/tags/cache/clear

清除标签库缓存，在下次请求时强制刷新。

**响应：**
```json
{
  "success": true,
  "message": "ok",
  "data": {
    "message": "Tag cache cleared successfully"
  },
  "error": null,
  "timestamp": "2025-11-15T08:20:11.097Z",
  "request_id": ""
}
```

### GET /api/tags/cache/status

获取标签库缓存的当前状态。

**响应：**
```json
{
  "success": true,
  "message": "ok",
  "data": {
    "cached": true,
    "age": 125000,
    "count": 35
  },
  "error": null,
  "timestamp": "2025-11-15T08:20:11.097Z",
  "request_id": ""
}
```

## 配置说明

在 `config.json` 中添加预设标签：

```json
{
  "presetTags": [
    // 在此添加您的自定义预设标签
    "标签1",
    "标签2",
    "标签3"
  ],
  "autoTagEnabled": true,
  "tagSummaryMaxLength": 1000
}
```

## 实现细节

### 标签服务 (`tagService.ts`)

核心服务处理：
- **标签库管理**：合并预设标签和数据库标签
- **缓存机制**：5分钟 TTL 缓存以减少数据库查询
- **相似度匹配**：使用 Levenshtein 距离，阈值为 80%
- **规范化处理**：去重和近义词替换

### 集成点

1. **文件导入** (`saveFileHandler`)：LLM 提取标签后进行规范化
2. **标签更新** (`updateFileHandler`)：手动更新标签时进行规范化
3. **API 接口**：直接访问标签操作

## 性能考虑

- **缓存 TTL**：5分钟（可在代码中配置）
- **相似度阈值**：80%（可在代码中配置）
- **算法复杂度**：Levenshtein 距离为 O(n*m)，其中 n 和 m 是字符串长度

## 未来增强

可能的改进方向：
1. 用户可配置的相似度阈值
2. 支持多语言近义词词典
3. 标签使用统计和推荐
4. 自动标签合并建议
5. 与外部同义词 API 集成
